format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: flutter
trigger_map:
- push_branch: main
  workflow: android_release
- pull_request_source_branch: "*"
  workflow: android_release
workflows:
  android_release:
    summary: Build and Deploy APK for Mini Chat App
    steps:
    - git-clone@8:
        title: Clone repository
    - flutter-installer@0:
        title: Install Flutter SDK
        inputs:
        - version: stable
    - script@1:
        title: Flutter Build APK (Release)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            echo "Пошук проекту Flutter..."
            # Знаходимо папку, де лежить pubspec.yaml
            PROJECT_DIR=$(find . -name "pubspec.yaml" -exec dirname {} \; | head -n 1)

            if [ -z "$PROJECT_DIR" ]; then
              echo "ПОМИЛКА: Не знайдено файл pubspec.yaml у репозиторії!"
              ls -R # Виводимо список файлів для діагностики, якщо не знайшли
              exit 1
            fi

            echo "Проект знайдено в: $PROJECT_DIR"
            cd "$PROJECT_DIR"

            echo "Запуск збірки APK..."
            flutter build apk --release

            # Знаходимо згенерований файл
            APK_PATH_LOCAL=$(find build/app/outputs/flutter-apk -name "app-release.apk" | head -n 1)

            if [ -z "$APK_PATH_LOCAL" ]; then
              echo "ПОМИЛКА: APK не знайдено після збірки!"
              exit 1
            fi

            ABS_APK_PATH="$(pwd)/$APK_PATH_LOCAL"
            echo "APK успішно створено: $ABS_APK_PATH"
            
            envman add --key APK_PATH --value "$ABS_APK_PATH"
    - script@1:
        title: Upload to Firebase App Distribution
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            if [ -z "$FIREBASE_TOKEN" ] || [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
              echo "ERROR: FIREBASE_TOKEN або FIREBASE_APP_ID_ANDROID не встановлені в Secrets!"
              exit 1
            fi

            echo "Встановлення Firebase CLI..."
            npm install -g firebase-tools

            echo "Завантаження у Firebase..."
            firebase appdistribution:distribute "$APK_PATH" \
              --app "$FIREBASE_APP_ID_ANDROID" \
              --token "$FIREBASE_TOKEN" \
              --groups "testers" \
              --release-notes "Build from Bitrise - $(date +'%Y-%m-%d %H:%M')"
    - deploy-to-bitrise-io@2:
        title: Deploy to Bitrise.io
        inputs:
        - is_compress: 'false'
        - deploy_path: "$APK_PATH"
app:
  envs:
  - FLUTTER_VERSION: stable