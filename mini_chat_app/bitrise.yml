format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: flutter
trigger_map:
- push_branch: main
  workflow: android_release
- pull_request_source_branch: "*"
  workflow: android_release
workflows:
  android_release:
    summary: Build and Deploy APK for Mini Chat App
    steps:
    - git-clone@8:
        title: Clone repository
    - flutter-installer@0:
        title: Install Flutter SDK
        inputs:
        - version: stable
    - script@1:
        title: Flutter Build APK (Release)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            # Переходимо в папку проекту, яку ми вказали в envs
            cd "$BITRISE_FLUTTER_PROJECT_LOCATION"

            echo "Building Android APK in Release mode..."
            flutter build apk --release

            # Шукаємо APK у папці build всередині main_chat_app
            APK_PATH_LOCAL=$(find build/app/outputs/flutter-apk -name "app-release.apk" | head -n 1)

            if [ -z "$APK_PATH_LOCAL" ]; then
              echo "ERROR: APK not found!"
              exit 1
            fi

            # Експортуємо повний шлях для Firebase та Bitrise Deploy
            ABS_APK_PATH="$(pwd)/$APK_PATH_LOCAL"
            echo "APK successfully built at: $ABS_APK_PATH"
            
            envman add --key APK_PATH --value "$ABS_APK_PATH"
    - script@1:
        title: Upload to Firebase App Distribution
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            if [ -z "$FIREBASE_TOKEN" ] || [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
              echo "ERROR: FIREBASE_TOKEN or FIREBASE_APP_ID_ANDROID is not set!"
              exit 1
            fi

            echo "Installing Firebase CLI..."
            npm install -g firebase-tools

            echo "Uploading APK to Firebase..."
            firebase appdistribution:distribute "$APK_PATH" \
              --app "$FIREBASE_APP_ID_ANDROID" \
              --token "$FIREBASE_TOKEN" \
              --groups "testers" \
              --release-notes "New build for Mini Chat App - $(date +'%Y-%m-%d %H:%M')"
    - deploy-to-bitrise-io@2:
        title: Deploy to Bitrise.io
        inputs:
        - is_compress: 'false'
        - deploy_path: "$APK_PATH"
app:
  envs:
  # Тепер вказано правильний шлях до папки з Flutter проектом
  - BITRISE_FLUTTER_PROJECT_LOCATION: "main_chat_app"
  - FLUTTER_VERSION: stable