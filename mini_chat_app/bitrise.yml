format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: flutter
trigger_map:
- push_branch: main
  workflow: android_release
- pull_request_source_branch: "*"
  workflow: android_release
workflows:
  android_release:
    summary: Build and Deploy APK for Mini Chat App
    steps:
    - git-clone@8:
        title: Clone repository
    - flutter-installer@0:
        title: Install Flutter SDK
        inputs:
        - version: stable
    - script@1:
        title: Flutter Build APK (Release)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            echo "Building Android APK in Release mode..."
            flutter build apk --release

            # Шлях до згенерованого APK
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"

            if [ ! -f "$APK_PATH" ]; then
              echo "ERROR: APK not found!"
              exit 1
            fi

            echo "APK successfully built at: $APK_PATH"
            # Експорт шляху для наступних кроків
            envman add --key APK_PATH --value "$APK_PATH"
    - script@1:
        title: Upload to Firebase App Distribution
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            if [ -z "$FIREBASE_TOKEN" ] || [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
              echo "ERROR: FIREBASE_TOKEN or FIREBASE_APP_ID_ANDROID is not set in Bitrise Secrets!"
              exit 1
            fi

            echo "Installing Firebase CLI..."
            npm install -g firebase-tools

            echo "Uploading APK to Firebase..."
            firebase appdistribution:distribute "$APK_PATH" \
              --app "$FIREBASE_APP_ID_ANDROID" \
              --token "$FIREBASE_TOKEN" \
              --groups "testers" \
              --release-notes "New build for Mini Chat App - $(date +'%Y-%m-%d %H:%M')"

            echo "Upload complete!"
    - deploy-to-bitrise-io@2:
        title: Deploy to Bitrise.io
        inputs:
        - is_compress: 'false'
        - deploy_path: "$APK_PATH"
app:
  envs:
  - BITRISE_FLUTTER_PROJECT_LOCATION: "."
  - FLUTTER_VERSION: stable